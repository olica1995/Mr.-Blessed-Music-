<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awere SS Titanium ERP | 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .ug-flag-top { border-top: 6px solid #000; }
        .ug-flag-mid { border-top: 6px solid #FCDC04; }
        .ug-flag-bot { border-top: 6px solid #D90000; }
        .sidebar-item { cursor: pointer; padding: 10px; border-radius: 8px; transition: 0.3s; }
        .sidebar-item:hover { background-color: #f3f4f6; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="ug-flag-top"></div><div class="ug-flag-mid"></div><div class="ug-flag-bot"></div>

    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h1 class="text-2xl font-bold text-center text-blue-900 mb-6">AWERE SS PORTAL</h1>
            <div class="space-y-4">
                <select id="login-role" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="learner">Student / Learner</option>
                    <option value="teacher">Class Teacher</option>
                    <option value="bursar">Bursar (Finance)</option>
                    <option value="dos">D.O.S (Academics)</option>
                    <option value="admin">Headteacher / Deputy</option>
                </select>
                <input type="text" id="login-id" placeholder="LIN or Staff Name" class="w-full p-3 border rounded-lg">
                <input type="password" id="login-pw" placeholder="Security Password" class="w-full p-3 border rounded-lg">
                <button onclick="handleLogin()" class="w-full bg-blue-900 text-white p-3 rounded-lg font-bold hover:bg-black transition">Enter System</button>
            </div>
        </div>
    </div>

    <div id="portal" class="hidden flex flex-col md:flex-row min-h-screen">
        <aside class="w-full md:w-64 bg-white shadow-xl p-6 space-y-6">
            <div class="text-center pb-6 border-b">
                <h2 id="display-name" class="font-bold text-lg text-blue-900">User Name</h2>
                <p id="display-role" class="text-xs uppercase text-gray-500 tracking-widest">Role</p>
            </div>
            <nav id="menu-items" class="space-y-2 font-medium">
                </nav>
            <button onclick="location.reload()" class="w-full mt-10 text-red-600 text-sm font-bold border border-red-100 p-2 rounded">LOGOUT</button>
        </aside>

        <main class="flex-1 p-6 md:p-12">
            <div id="content-header" class="mb-8">
                <h2 id="section-title" class="text-3xl font-extrabold text-gray-800">Dashboard</h2>
                <p class="text-gray-500">Awere Secondary School Management System v2026</p>
            </div>
            
            <div id="main-view" class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                </div>
        </main>
    </div>

    <div id="qrcode" class="hidden"></div>

    <script>
        // --- FIREBASE CONFIG (REPLACE WITH YOUR KEYS) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let sessionUser = null;

        // --- AUTH LOGIC ---
        async function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const role = document.getElementById('login-role').value;

            try {
                const userDoc = await db.collection("users").doc(id.toLowerCase()).get();
                if (userDoc.exists && userDoc.data().password === pw && userDoc.data().role === role) {
                    sessionUser = { id, ...userDoc.data() };
                    launchPortal();
                } else {
                    alert("‚ö†Ô∏è Access Denied: Check LIN/Name or Password.");
                }
            } catch (e) { alert("Connection Error. Check internet."); }
        }

        function launchPortal() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
            document.getElementById('display-name').innerText = sessionUser.name;
            document.getElementById('display-role').innerText = sessionUser.role;
            buildMenu();
        }

        // --- PERMISSIONS ENGINE ---
        function buildMenu() {
            const menu = document.getElementById('menu-items');
            const r = sessionUser.role;
            let html = `<div class="sidebar-item" onclick="showDashboard()">üè† Home</div>`;

            if (r === 'admin' || r === 'dos' || r === 'teacher') {
                html += `<div class="sidebar-item" onclick="showMarkEntry()">‚úçÔ∏è Enter Marks</div>`;
                html += `<div class="sidebar-item" onclick="showNotes()">üìö Upload Notes</div>`;
            }
            if (r === 'admin' || r === 'dos') {
                html += `<div class="sidebar-item" onclick="showRankings()">üèÜ Class Rankings</div>`;
                html += `<div class="sidebar-item" onclick="showEnrollment()">üë• Enroll Student/Staff</div>`;
            }
            if (r === 'admin' || r === 'bursar') {
                html += `<div class="sidebar-item" onclick="showFees()">üíµ Fees Management</div>`;
            }
            html += `<div class="sidebar-item" onclick="showReportCard()">üìÑ My Report Card</div>`;
            menu.innerHTML = html;
        }

        // --- ACADEMIC LOGIC (80/20 + A-E GRADING) ---
        function calculateGrade(aoi, exam) {
            const final = ((aoi / 3) * 20) + (exam * 0.8);
            if (final >= 80) return { g: "A", d: "Exceptional" };
            if (final >= 70) return { g: "B", d: "Outstanding" };
            if (final >= 60) return { g: "C", d: "Satisfactory" };
            if (final >= 40) return { g: "D", d: "Basic" };
            return { g: "E", d: "Elementary" };
        }

        // --- FEATURE: MARK ENTRY ---
        function showMarkEntry() {
            document.getElementById('section-title').innerText = "Academics: Mark Entry";
            document.getElementById('main-view').innerHTML = `
                <div class="space-y-4">
                    <input type="text" id="m-lin" placeholder="Student LIN" class="w-full p-2 border">
                    <select id="m-sub" class="w-full p-2 border">
                        <option>Mathematics</option><option>English</option><option>Physics</option>
                    </select>
                    <input type="number" id="m-aoi" placeholder="AoI Score (0.9 - 3.0)" class="w-full p-2 border">
                    <input type="number" id="m-exam" placeholder="Exam Score (0 - 100)" class="w-full p-2 border">
                    <button onclick="saveMarks()" class="bg-blue-900 text-white p-2 w-full rounded">Save to Cloud</button>
                </div>`;
        }

        async function saveMarks() {
            const lin = document.getElementById('m-lin').value.toLowerCase();
            const data = {
                subject: document.getElementById('m-sub').value,
                aoi: parseFloat(document.getElementById('m-aoi').value),
                exam: parseFloat(document.getElementById('m-exam').value),
                teacher: sessionUser.name,
                date: new Date().toISOString()
            };
            await db.collection("marks").doc(`${lin}_${data.subject}`).set(data, {merge: true});
            alert("‚úÖ Marks Saved Permanently.");
        }

        // --- FEATURE: REPORT CARD + QR ---
        async function showReportCard() {
            document.getElementById('section-title').innerText = "My Academic Progress";
            const view = document.getElementById('main-view');
            view.innerHTML = `<p class="text-blue-700 animate-pulse">Generating Secure Report Card...</p>`;
            
            // In a real scenario, fetch student marks & fee status from Firestore
            setTimeout(() => {
                view.innerHTML = `
                <div class="p-6 border-2 border-blue-900 rounded-lg">
                    <h3 class="text-xl font-bold mb-4">Official Report: ${sessionUser.name}</h3>
                    <p class="mb-4">Status: <span class="text-green-600 font-bold">FEES CLEARED</span></p>
                    <div id="qr-area" class="mb-6"></div>
                    <button onclick="downloadPDF()" class="bg-black text-white px-4 py-2 rounded">Download PDF</button>
                </div>`;
                new QRCode(document.getElementById("qr-area"), {
                    text: `AWERE SS: ${sessionUser.name} | RANK: 1st | VERIFIED 2026`,
                    width: 128, height: 128
                });
            }, 1000);
        }

    </script>
</body>
</html>
